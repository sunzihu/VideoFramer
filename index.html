<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视频帧提取器</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f8f8;
    }
    .container {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    .function-area {
      display: flex;
      justify-content: space-around;
      padding: 30px 0;
      background-color: white;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .action-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 15px 30px;
      transition: all 0.3s;
    }
    .action-item:hover {
      background-color: #f0f8ff;
      border-radius: 8px;
    }
    .action-icon {
      width: 50px;
      height: 50px;
      margin-bottom: 10px;
    }
    .action-label {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }
    .media-info {
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .duration {
      margin-top: 10px;
      color: #666;
    }
    .preview-container {
      margin-top: 20px;
    }
    .preview-video {
      width: 100%;
      max-height: 400px;
      background-color: #000;
      border-radius: 10px;
    }
    .extract-btn {
      width: 100%;
      padding: 15px 0;
      background-color: #007AFF;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      margin-top: 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .extract-btn:hover:not(:disabled) {
      background-color: #0056b3;
    }
    .extract-btn:disabled {
      background-color: #CCCCCC;
      cursor: not-allowed;
    }
    .progress-container {
      margin-top: 20px;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .progress-text {
      text-align: center;
      font-size: 16px;
      margin-top: 10px;
      color: #666;
    }
    .results-container {
      margin-top: 20px;
      padding: 20px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .frames-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    .frame-item {
      border: 1px solid #eee;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s;
    }
    .frame-item:hover {
      transform: translateY(-5px);
    }
    .frame-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    .frame-index {
      padding: 10px;
      font-size: 14px;
      text-align: center;
      color: #666;
      background-color: #f9f9f9;
    }
    h1, h2 {
      color: #333;
      text-align: center;
    }
    .debug-info {
      margin-top: 20px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
      display: none;
    }
    /* 隐藏元素 */
    .hidden-canvas {
      position: absolute;
      top: -1000px;
      left: -1000px;
    }
  </style>
</head>
<body>
  <div id="app" class="container">
    <h1>视频帧提取器</h1>
    
    <!-- 功能区 -->
    <div class="function-area">
      <!-- 拍摄照片区域 -->
      <div class="action-item" @click="takePhoto">
        <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        <div class="action-label">拍照</div>
      </div>

      <!-- 拍摄视频区域 -->
      <div class="action-item" @click="paisheVideo">
        <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
          <line x1="7" y1="2" x2="7" y2="22"></line>
          <line x1="17" y1="2" x2="17" y2="22"></line>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <line x1="2" y1="7" x2="7" y2="7"></line>
          <line x1="2" y1="17" x2="7" y2="17"></line>
          <line x1="17" y1="17" x2="22" y2="17"></line>
          <line x1="17" y1="7" x2="22" y2="7"></line>
        </svg>
        <div class="action-label">拍摄视频</div>
      </div>

      <!-- 上传视频区域 -->
      <div class="action-item" @click="uploadVideo">
        <svg class="action-icon" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="17 8 12 3 7 8"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        <div class="action-label">上传媒体</div>
      </div>
    </div>

    <!-- 操作反馈 -->
    <div v-if="mediaPath" class="media-info">
      <div>{{ actionType === 'photo' ? '已拍摄照片' : actionType === 'record' ? '已录制视频' : '已选择视频' }}</div>
      <div v-if="actionType !== 'photo'" class="duration">时长: {{ durationLen }}秒</div>
      <div v-if="savedToAlbum" class="save-success">已保存到相册</div>

      <!-- 视频预览 -->
      <div v-if="actionType !== 'photo'" class="preview-container">
        <video :src="mediaPath" controls class="preview-video" ref="previewVideo" id="idvideo"
          @loadedmetadata="onVideoLoaded"></video>
      </div>
    </div>

    <!-- 提取按钮 -->
    <button class="extract-btn" @click="extractFrames" :disabled="isExtracting || !mediaPath || actionType === 'photo'">
      {{ isExtracting ? '提取中...' : '每1秒提取一帧' }}
    </button>

    <!-- 进度显示 -->
    <div v-if="isExtracting" class="progress-container">
      <progress :value="extractProgress" max="100" style="width: 100%; height: 20px;"></progress>
      <div class="progress-text">提取进度: {{ extractProgress }}%</div>
    </div>

    <!-- 结果展示区域 -->
    <div v-if="hasResults" class="results-container">
      <h2>提取的帧 (每1秒1帧)</h2>
      <div class="frames-grid">
        <div v-for="(frame, index) in frames" :key="index" class="frame-item">
          <img :src="frame.path" :alt="'第' + frame.second + '秒的帧'" class="frame-image">
          <div class="frame-index">第{{ frame.second }}秒</div>
        </div>
      </div>
    </div>
    
    <!-- 隐藏的canvas用于处理视频帧 -->
    <canvas id="frameCanvas" class="hidden-canvas" width="480" height="360"></canvas>
    
    <!-- 调试信息 -->
    <div class="debug-info" v-if="debugInfo">{{ debugInfo }}</div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        mediaPath: null,
        durationLen: 0,
        actionType: '',
        savedToAlbum: false,
        frames: [], // 存储所有提取的帧
        hasResults: false,

        // Canvas 尺寸
        canvasWidth: 480,
        canvasHeight: 360,
        // 帧提取相关
        totalFramesToExtract: 0,
        currentExtractIndex: 0,
        extractInterval: 1, // 修改为1秒一帧

        isExtracting: false,
        extractProgress: 0,
        videoStreamUrl: '',
        debugInfo: ''
      },
      mounted() {
        // 获取canvas上下文
        this.frameCanvasContext = document.getElementById('frameCanvas').getContext('2d');
      },
      methods: {
        // 拍摄照片
        takePhoto() {
          alert('在网页版中无法使用相机功能。请在移动设备上使用此功能。');
        },
        
        // 拍摄视频
        paisheVideo() {
          alert('在网页版中无法使用视频录制功能。请在移动设备上使用此功能。');
        },
        
        // 上传视频
        uploadVideo() {
          // 创建一个文件输入元素
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'video/*';
          
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const url = URL.createObjectURL(file);
              this.mediaPath = url;
              this.actionType = 'upload';
              this.savedToAlbum = false;
              this.frames = []; // 清空帧数据
              this.hasResults = false;
              this.isExtracting = false;
              this.extractProgress = 0;
              
              // 直接使用选择的视频路径
              this.log('视频已选择: ' + file.name);
              
              // 初始化视频上下文
              this.$nextTick(() => {
                const video = this.$refs.previewVideo;
                if (video) {
                  video.onloadedmetadata = this.onVideoLoaded;
                }
              });
            }
          };
          
          input.click();
        },
        
        // 视频加载完成
        onVideoLoaded(e) {
          const video = this.$refs.previewVideo;
          this.durationLen = Math.floor(video.duration);
          this.canvasWidth = video.videoWidth || 640;
          this.canvasHeight = video.videoHeight || 480;
          
          // 更新canvas尺寸
          const canvas = document.getElementById('frameCanvas');
          canvas.width = this.canvasWidth;
          canvas.height = this.canvasHeight;
          
          this.log(`视频元数据已加载，尺寸: ${this.canvasWidth}x${this.canvasHeight}, 时长: ${this.durationLen}秒`);
        },
        
        // 提取视频每1秒的帧
        extractFrames() {
          if (!this.mediaPath || this.actionType === 'photo') {
            alert('请先选择视频');
            return;
          }

          // 检查视频时长是否大于等于1秒
          if (this.durationLen < this.extractInterval) {
            alert('视频时长不足1秒');
            return;
          }

          this.isExtracting = true;
          this.frames = []; // 清空原有结果
          this.hasResults = false;
          this.extractProgress = 0;

          // 计算需要提取的总帧数
          this.totalFramesToExtract = Math.floor(this.durationLen / this.extractInterval);
          this.currentExtractIndex = 0;
          
          this.log(`开始提取帧，总计: ${this.totalFramesToExtract}帧`);

          // 开始逐帧提取
          this.extractNextFrame();
        },
        
        // 提取下一帧
        extractNextFrame() {
          if (this.currentExtractIndex >= this.totalFramesToExtract) {
            // 所有帧提取完成
            this.extractProgress = 100;
            this.isExtracting = false;
            this.hasResults = true;
            this.log(`提取完成，共提取了${this.frames.length}帧`);
            return;
          }

          // 计算当前要提取的时间点（秒）
          const currentSecond = (this.currentExtractIndex + 1) * this.extractInterval;

          // 更新进度
          this.extractProgress = Math.floor((this.currentExtractIndex / this.totalFramesToExtract) * 100);
          
          this.log(`提取第${currentSecond}秒的帧`);

          // 获取视频元素
          const video = this.$refs.previewVideo;
          
          // 跳转到目标时间点
          video.currentTime = currentSecond;

          // 视频就绪后截取帧
          const onSeeked = () => {
            try {
              // 确保视频已暂停在目标帧
              video.pause();
              
              // 使用setTimeout确保视频已经完全暂停在正确的位置
              setTimeout(() => {
                try {
                  // 清除画布
                  this.frameCanvasContext.clearRect(0, 0, this.canvasWidth, this.canvasHeight);
                  
                  // 绘制视频帧到canvas
                  this.frameCanvasContext.drawImage(video, 0, 0, this.canvasWidth, this.canvasHeight);
                  
                  // 将canvas转换为图片
                  const canvas = document.getElementById('frameCanvas');
                  const imgUrl = canvas.toDataURL('image/jpeg', 0.9);
                  
                  this.log(`第${currentSecond}秒帧已捕获，数据长度: ${imgUrl.length}`);
                  
                  // 添加到结果中
                  this.frames.push({
                    path: imgUrl,
                    second: currentSecond
                  });
                  
                  // 继续提取下一帧
                  this.currentExtractIndex++;
                  setTimeout(() => {
                    this.extractNextFrame();
                  }, 200);
                } catch (error) {
                  this.log(`绘制帧错误: ${error.message}`);
                  this.isExtracting = false;
                }
              }, 100);
            } catch (error) {
              this.log(`捕获帧错误: ${error.message}`);
              this.isExtracting = false;
            }
            
            // 移除事件监听，避免重复触发
            video.removeEventListener('seeked', onSeeked);
          };
          
          video.addEventListener('seeked', onSeeked);
        },
        
        // 日志记录
        log(message) {
          console.log(message);
          // 如果需要在界面上显示调试信息，取消下面这行的注释
          // this.debugInfo += message + '\n';
        }
      }
    });
  </script>
</body>
</html>